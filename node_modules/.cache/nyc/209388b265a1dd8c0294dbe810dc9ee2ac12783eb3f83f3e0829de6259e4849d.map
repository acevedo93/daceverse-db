{"version":3,"sources":["src/tests/metric.spec.js"],"names":["test","require","proxyquire","sinon","agentFixtures","metricFixtures","sandbox","uuid","type","config","logging","uuidArgs","where","AgentStub","hasMany","spy","findAllArgs","attributes","group","include","model","raw","findByTypeUuidArgs","limit","order","newMetric","value","MetricStub","db","beforeEach","createSandbox","belongsTo","create","stub","withArgs","returns","Promise","resolve","toJSON","findAll","all","findByTypeAgentUuid","findByAgentuuid","findOne","byuuid","setupDatabase","afterEach","restore","serial","t","pass","truthy","Metric","true","called","calledWith","calledOnce","metric","deepEqual","findByAgentUuid"],"mappings":"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","sourceRoot":"/home/david/code/daceverse/daceverse-db","sourcesContent":["'use strict'\nconst test = require('ava')\nconst proxyquire = require('proxyquire')\nconst sinon = require('sinon')\nconst agentFixtures = require('./fixtures/agent.fixture')\nconst metricFixtures = require('./fixtures/metric.fixture')\nlet sandbox = null\nconst uuid = 'yyy-yyy-yyy'\nconst type = 'fixture'\nconst config = {\n  // este objeto de configuracion se le pasa a la base solo como base\n  // la configuracion de la base de prueba se genera en index validando que tiene esa config\n  logging: function () {}\n}\nconst uuidArgs = {\n  where: { uuid }\n}\n\nconst AgentStub = {\n  hasMany: sinon.spy()\n}\nconst findAllArgs = {\n  attributes: ['type'],\n  group: ['type'],\n  include: [{\n    attributes: [],\n    model: AgentStub,\n    where: {\n      uuid\n    }\n  }],\n  raw: true\n}\n// agent stub\nconst findByTypeUuidArgs = {\n  attributes: ['id', 'type', 'value', 'createdAt'],\n  where: {\n    type\n  },\n  limit: 20,\n  order: [['createdAt', 'DESC']],\n  include: [{\n    attributes: [],\n    model: AgentStub,\n    where: {\n      uuid\n    }\n\n  }],\n  raw: true\n}\n\nconst newMetric = {\n  type: 'fixture',\n  value: 900\n  // createdAt: new Date(),\n  // updatedAt: new Date()\n}\n\nlet MetricStub = null\nlet db = null\ntest.beforeEach(async () => {\n  sandbox = sinon.createSandbox()\n  MetricStub = {\n    belongsTo: sandbox.spy()\n  }\n  // metric stub\n  MetricStub.create = sandbox.stub()\n  MetricStub.create.withArgs().returns(Promise.resolve({\n    toJSON () {\n      return metricFixtures.newMetric\n    }\n  }))\n\n  // find by type and uuid\n  MetricStub.findAll = sandbox.stub()\n  MetricStub.findAll.withArgs().returns(Promise.resolve(metricFixtures.all))\n  MetricStub.findAll.withArgs(findByTypeUuidArgs).returns(Promise.resolve(metricFixtures.findByTypeAgentUuid(type, uuid)))\n  // find by agent uuid\n  MetricStub.findAll.withArgs(findAllArgs).returns(Promise.resolve(metricFixtures.findByAgentuuid(uuid)))\n  // agent stub\n  AgentStub.findOne = sandbox.stub()\n  AgentStub.findOne.withArgs(uuidArgs).returns(Promise.resolve(agentFixtures.byuuid(uuid)))\n  // obtenemos el modulo de configuracion de base de datos\n  const setupDatabase = proxyquire('../', {\n    './models/agent': () => AgentStub,\n    './models/metric': () => MetricStub\n  })\n  db = await setupDatabase(config)\n})\n\ntest.afterEach(async () => {\n  sandbox && sandbox.restore()\n})\ntest.serial('make it pass', t => {\n  t.pass()\n})\n\ntest.serial('metric exist', t => {\n  t.truthy(db.Metric, 'Metric service should exist')\n})\n\ntest.serial('setup', t => {\n  t.true(AgentStub.hasMany.called, 'shoyuld be execute')\n  t.true(MetricStub.belongsTo.called, 'should be execute')\n  t.true(AgentStub.hasMany.calledWith(MetricStub), 'Argument should be the MetricModel')\n  t.true(MetricStub.belongsTo.called, 'belongsTo was executed')\n  t.true(MetricStub.belongsTo.calledOnce, 'belongsTo was executed once')\n  t.true(MetricStub.belongsTo.calledWith(AgentStub), 'Argument should be the AgentStub')\n})\n\ntest.serial('Metric#create', async t => {\n  // creacion de metrica\n  // la diferencia entre new Metric y metricFixture.newMetric\n  // es que cuando usamos newMetric el id del cliente aun no fue agregado al objeto\n  const metric = await db.Metric.create(uuid, newMetric)\n  t.true(AgentStub.findOne.called, 'findONe should be called one')\n  t.true(AgentStub.findOne.calledOnce, 'findONe called once')\n  t.true(AgentStub.findOne.calledWith(uuidArgs), 'find One should be calle with uuid argument')\n  t.true(MetricStub.create.called, 'should be called')\n  t.true(MetricStub.create.calledOnce, 'create should be called once')\n  t.true(MetricStub.create.calledWith(metricFixtures.newMetric), 'create should be called with specified newMetric Args')\n  t.deepEqual(metric, metricFixtures.newMetric, 'metric should be the same')\n})\n\ntest.serial('Metric#findByAgentUuid', async t => {\n  const metric = await db.Metric.findByAgentUuid(uuid)\n\n  t.true(MetricStub.findAll.called, 'find all should be called')\n  t.true(MetricStub.findAll.calledOnce, 'findAll should be called once')\n  t.true(MetricStub.findAll.calledWith(findAllArgs), 'findAll should be called without args')\n  t.deepEqual(metric, metricFixtures.findByAgentuuid(uuid))\n})\n\ntest.serial('Metric#findByTypeAgentUuid', async t => {\n  const metric = await db.Metric.findByTypeAgentUuid(type, uuid)\n  t.true(MetricStub.findAll.called, 'find all should be called')\n  t.true(MetricStub.findAll.calledOnce, 'findAll should be called once')\n  t.true(MetricStub.findAll.withArgs(findByTypeUuidArgs), 'find all with arguments')\n})\n"]}