{"version":3,"sources":["src/tests/agent.spec.js"],"names":["db","test","require","proxyquire","sinon","agentFixtures","config","logging","sandbox","MetricStub","belongsTo","spy","single","newAgent","id","uuid","username","uuidArgs","where","ArgsConnected","connected","ArgsUserName","AgentStub","beforeEach","createSandbox","hasMany","findById","stub","withArgs","returns","Promise","resolve","findOne","byuuid","update","create","findAll","all","userName","setupDatabase","afterEach","t","restore","pass","truthy","Agent","serial","true","called","calledWith","agent","calledOnce","deepEqual","createOrUpdate","calledTwice","agents","is","length","findConnected","findByUserName"],"mappings":"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","sourceRoot":"/home/david/code/daceverse/daceverse-db","sourcesContent":["'use strict'\n\nlet db = null\nconst test = require('ava')\nconst proxyquire = require('proxyquire')\nconst sinon = require('sinon')\nconst agentFixtures = require('./fixtures/agent.fixture')\n\nconst config = {\n  // disable loggin\n  logging: function () {}\n}\nlet sandbox = null\nconst MetricStub = {\n  belongsTo: sinon.spy()\n}\n\nconst single = { ...agentFixtures.single }\nconst newAgent = { ...agentFixtures.newAgent }\nconst id = 1\nconst uuid = 'yyy-yyy-yyy'\nconst username = 'dodorian'\nconst uuidArgs = {\n  where: {\n    uuid\n  }\n}\nconst ArgsConnected = {\n  where: {\n    connected: true\n  }\n}\nconst ArgsUserName = {\n  where: {\n    username\n  }\n}\n\nlet AgentStub = null\n// -------------------------------//\ntest.beforeEach(async () => {\n  sandbox = sinon.createSandbox()\n\n  AgentStub = {\n    hasMany: sandbox.spy()\n  }\n  // find By Id\n  AgentStub.findById = sandbox.stub()\n  AgentStub.findById.withArgs(id).returns(Promise.resolve(agentFixtures.findById(id)))\n  // createOrupdate when user exists\n  AgentStub.findOne = sandbox.stub()\n  AgentStub.findOne.withArgs(uuidArgs).returns(Promise.resolve(agentFixtures.byuuid(uuid)))\n\n  AgentStub.update = sandbox.stub()\n  AgentStub.update.withArgs(single, uuidArgs).returns(Promise.resolve(single))\n  AgentStub.create = sandbox.stub()\n  AgentStub.create.withArgs(newAgent).returns(Promise.resolve(newAgent))\n  // find all\n  AgentStub.findAll = sandbox.stub()\n  AgentStub.findAll.withArgs().returns(Promise.resolve(agentFixtures.all))\n  AgentStub.findAll.withArgs(ArgsConnected).returns(Promise.resolve(agentFixtures.connected))\n  AgentStub.findAll.withArgs(ArgsUserName).returns(Promise.resolve(agentFixtures.userName))\n  const setupDatabase = proxyquire('../', {\n    './models/agent': () => AgentStub,\n    './models/metric': () => MetricStub\n  })\n  db = await setupDatabase(config)\n})\n\ntest.afterEach(t => {\n  sandbox && sandbox.restore()\n})\n\ntest('make it pass', t => {\n  t.pass()\n})\n\ntest('Agent', t => {\n  t.truthy(db.Agent, 'Agent service should exist')\n})\n\ntest.serial('Setup', t => {\n  t.true(AgentStub.hasMany.called, 'AgentModel.hasmany was executed')\n  t.true(AgentStub.hasMany.calledWith(MetricStub), 'argument is full correct')\n  t.true(MetricStub.belongsTo.called, 'metricModel.belongsTo was executed')\n  t.true(MetricStub.belongsTo.calledWith(AgentStub), 'argument is full correct')\n})\ntest.serial('Agent#findById', async t => {\n  const agent = await db.Agent.findById(id)\n  t.true(AgentStub.findById.called, 'find by id is should be called')\n  t.true(AgentStub.findById.calledOnce, 'find by id is should be calledOnce')\n  t.true(AgentStub.findById.calledWith(id))\n  t.deepEqual(agent, agentFixtures.findById(id), 'should be the same')\n})\ntest.serial('Agent#createOrUpdate - when agent exists', async t => {\n  const agent = await db.Agent.createOrUpdate(single)\n  t.true(AgentStub.findOne.called, 'should be call')\n  t.true(AgentStub.findOne.calledTwice, 'should be call 2 times')\n  t.true(AgentStub.update.calledOnce, 'update should be calle once')\n  t.deepEqual(agent, single, 'Agent should be equal to single')\n})\ntest.serial('Agent#findAll', async t => {\n  const agents = await db.Agent.findAll()\n  t.true(AgentStub.findAll.called, 'findAll should be called on model')\n  t.true(AgentStub.findAll.calledOnce, 'findAll should be called once')\n  t.true(AgentStub.findAll.calledWith(), 'findAll should be called without args')\n  t.deepEqual(agents, agentFixtures.all, 'agents should be the same')\n  t.is(agents.length, agentFixtures.all.length, 'should be the same length')\n})\ntest.serial('Agents#findConnected', async t => {\n  const agents = await db.Agent.findConnected()\n  t.true(AgentStub.findAll.called, 'findAll should be called ')\n  t.true(AgentStub.findAll.calledOnce, 'findAll should be called once')\n  t.deepEqual(agents, agentFixtures.connected, 'should be equal')\n})\n\ntest.serial('Agents#findByUsername', async t => {\n  const agents = await db.Agent.findByUserName(username)\n  t.true(AgentStub.findAll.called, 'findAll should be called on model')\n  t.true(AgentStub.findAll.calledOnce, 'findAll should be called once')\n  t.true(AgentStub.findAll.calledWith(ArgsUserName), 'findAll should be called with username args')\n  t.deepEqual(agents, agentFixtures.userName, 'should be equal')\n})\n\ntest.serial('Agent#createOrUpdate - new', async t => {\n  const agent = await db.Agent.createOrUpdate(newAgent)\n\n  t.true(AgentStub.findOne.called, 'findOne should be called on model')\n  t.true(AgentStub.findOne.calledOnce, 'findOne should be called once')\n  t.true(AgentStub.findOne.calledWith({\n    where: { uuid: newAgent.uuid }\n  }), 'findOne should be called with uuid args')\n  t.true(AgentStub.create.called, 'create should be called on model')\n  t.true(AgentStub.create.calledOnce, 'create should be called once')\n  t.true(AgentStub.create.calledWith(newAgent), 'create should be called with specified args')\n\n  t.deepEqual(agent, newAgent, 'agent should be the same')\n})"]}